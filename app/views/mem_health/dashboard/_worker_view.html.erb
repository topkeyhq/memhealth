<!-- Highest Memory Usage Job - Prominent display -->
<% if @max_memory_item %>
  <div class="bg-red-50 border border-red-200 rounded-lg px-6 py-6 mb-6">
    <h3 class="text-lg font-semibold text-red-800 mb-4">ðŸš¨ Highest Memory Usage Job</h3>

    <div class="bg-white rounded-md px-6 py-4 border border-red-100">
      <!-- Job Section -->
      <div class="mb-4">
        <dt class="text-sm font-medium text-gray-500 mb-1">Worker Class</dt>
        <dd class="text-sm text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded ml-0">
          <%= @max_memory_item["worker_class"] %>
        </dd>
        <% if @max_memory_item["job_args"].present? %>
          <dt class="text-sm font-medium text-gray-500 mb-1 mt-2">Arguments</dt>
          <dd class="text-xs text-gray-600 font-mono bg-gray-50 px-2 py-1 rounded ml-0 break-all">
            <%= @max_memory_item["job_args"] %>
          </dd>
        <% end %>
      </div>

      <!-- Single row with all metadata -->
      <div class="flex gap-4">
        <div class="flex-1 text-left">
          <div class="bg-red-100 border border-red-300 rounded-md px-4 py-3">
            <dt class="text-sm font-medium text-red-700 mb-1">Memory Diff</dt>
            <dd class="text-lg font-bold text-red-800 ml-0">
              <%= @max_memory_item["memory_diff"] %> MB
            </dd>
          </div>
        </div>

        <div class="flex-1 text-left">
          <dt class="text-sm font-medium text-gray-500 mb-1">RAM Usage</dt>
          <dd class="text-sm text-gray-600 ml-0">
            <%= @max_memory_item["ram_before"] %> MB â†’ <%= @max_memory_item["ram_after"] %> MB
          </dd>
        </div>

        <div class="flex-1 text-left">
          <dt class="text-sm font-medium text-gray-500 mb-1">Execution Time</dt>
          <dd class="text-sm text-gray-600 ml-0">
            <%= @max_memory_item["execution_time"] ? "#{@max_memory_item["execution_time"]} s" : "-" %>
          </dd>
        </div>

        <div class="flex-1 text-left">
          <dt class="text-sm font-medium text-gray-500 mb-1">Queue</dt>
          <dd class="text-sm text-gray-600 ml-0">
            <%= @max_memory_item["queue"] || "-" %>
          </dd>
        </div>

        <div class="flex-1 text-left">
          <dt class="text-sm font-medium text-gray-500 mb-1">Info</dt>
          <dd class="text-sm text-gray-600 ml-0">
            <% info_parts = [] %>
            <% info_parts << @max_memory_item["dyno"] if @max_memory_item["dyno"] %>
            <% info_parts << Time.parse(@max_memory_item["recorded_at"]).utc.strftime("%m/%d %H:%M") %>
            <%= info_parts.join(" / ") %>
          </dd>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Stats summary card -->
<div class="bg-white rounded-lg shadow px-6 py-6 mb-6">
  <h3 class="text-lg font-medium text-gray-900 mb-4">Worker Memory Usage Statistics</h3>

  <div class="flex gap-4">
    <div class="bg-blue-50 p-4 rounded-md flex-1 text-left">
      <dt class="text-sm font-medium text-blue-600">Max Memory Difference</dt>
      <dd class="mt-1 text-2xl font-semibold text-blue-900 text-left ml-0"><%= @stats[:max_memory_diff] %> MB</dd>
    </div>

    <div class="bg-green-50 p-4 rounded-md flex-1 text-left">
      <dt class="text-sm font-medium text-green-600">Stored Jobs</dt>
      <dd class="mt-1 text-2xl font-semibold text-green-900 text-left ml-0"><%= @stats[:stored_jobs_count] %>/<%= @stats[:max_stored_jobs] %></dd>
    </div>
  </div>
</div>

<!-- Top Jobs table -->
<% if @top_items.any? %>
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">Top <%= MemHealth.configuration.max_stored_urls %> Jobs by Memory Usage</h3>
      <p class="text-sm text-gray-600 mt-1">Jobs ordered by memory difference (highest first) - maximum <%= MemHealth.configuration.max_stored_urls %> jobs stored</p>
    </div>

    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Memory Diff</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RAM Before</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RAM After</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Exec Time</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Worker Class / Args</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Queue</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dyno</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recorded At</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <% @top_items.each do |job_data| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <%
                memory_color = if job_data["memory_diff"] > 10
                  "bg-red-100 text-red-800"
                elsif job_data["memory_diff"] > 5
                  "bg-yellow-100 text-yellow-800"
                else
                  "bg-green-100 text-green-800"
                end
              %>
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full <%= memory_color %>">
                <%= job_data["memory_diff"] %> MB
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= job_data["ram_before"] ? "#{job_data["ram_before"]} MB" : "/" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= job_data["ram_after"] ? "#{job_data["ram_after"]} MB" : "/" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= job_data["execution_time"] ? "#{job_data["execution_time"]} s" : "/" %>
            </td>
            <td class="px-6 py-4 text-gray-700">
              <div>
                <code class="bg-gray-100 px-1 py-0.5 rounded text-xs"><%= job_data["worker_class"] %></code>
                <% if job_data["job_args"].present? %>
                  <div class="text-xs text-gray-500 mt-1 font-mono truncate" title="<%= job_data["job_args"] %>">
                    <%= job_data["job_args"] %>
                  </div>
                <% end %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= job_data["queue"] || "/" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= job_data["dyno"] || "/" %>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 font-mono">
              <%= job_data["job_id"] ? job_data["job_id"][0..7] : "/" %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= Time.parse(job_data["recorded_at"]).utc.strftime("%Y-%m-%d %H:%M") %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="bg-white rounded-lg shadow px-6 py-4 text-center">
    <h3 class="text-lg font-medium text-gray-900 mb-2">No Jobs Tracked Yet</h3>
    <p class="text-gray-600">No background jobs have been recorded yet.</p>
    <p class="text-sm text-gray-500 mt-2">Memory tracking will begin once background jobs start running with the JobTrackingMiddleware enabled.</p>
  </div>
<% end %>
